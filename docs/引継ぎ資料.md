以下は、**最新の repomix（/mnt/data/repomix-output.xml）** を前提に、前回の引継ぎ資料を**現状に合わせて修正した「完全版」**です。
（※あなたのログにある通り、SSE の注入自体は通っていて、cartoon の再生成も走っています。）

---

# SSE-Diag 引継ぎ資料（完全版 / 最新repomix反映）

## 0. いま何が “できている” のか（結論）

**できている（MVPの核）**

* mmCIF をブラウザで読み込み（Mol* にパースさせる）
* Mol* が計算した標準 SSE（SecondaryStructureProvider）を取得して Map 化
* Mol* の Model から **residue key（chainId + labelSeqId）** を安定抽出
* “WASM想定” のエンジン出力（今は PrototypeRuleEngine）を使って
  **SecondaryStructureProvider の値（Map<unitId, SecondaryStructure>）を差し替え**
* その後に **cartoon 表現を作り直す（rebuildCartoonOnly）**
* diff（Mol*標準 vs WASM想定）も出せている

**まだ怪しい/不足しがち（あなたの体感と一致してる所）**

* 「色」が上書きされてない可能性が高い
  → 現状コードは **“色を上書きする指定” を明示していない**ため、cartoon が変わっても色が変わらないのは自然です（後述）。
* 「MVPとして当初想定していた“診断UI”」の部分（差分一覧を表で見せる、クリックで該当残基をハイライト、凡例など）はまだ薄い
* SSE注入の方式は “内部プロパティを直接差し替える” ため、Mol*バージョン差分に弱い（でも現状は動いてる）

---

## 1. 「当初目指していたMVP」到達判定

あなたのプロジェクト文脈（SSE診断・比較、WASM前提、Mol* SSOT）に照らすと、**当初MVPの最小要件はほぼ満たしています**。ただし「“診断”として見せる」部分に、あと数段の仕上げ余地があります。

### 1-1. MVP最小要件（現状評価）

| MVP要件                      | 目的            | 現状                                 |
| -------------------------- | ------------- | ---------------------------------- |
| mmCIFをローカル投入してMol*で表示      | SSOTをMol*に寄せる | ✅ loadMmcifText()                  |
| Mol*標準SSEを取得して比較できる        | baseline      | ✅ getMolstarStandardSse() + diff   |
| “外部計算（WASM想定）”のSSEをMol*に注入 | コア機能          | ✅ applyOverrideSseToMolstarModel() |
| 表示を更新して目視できる               | MVPデモ         | ✅ rebuildCartoonOnly() で再生成        |
| 変更がログで追える                  | デバッグ          | ✅ UIログ・consoleログ                   |

### 1-2. “当初MVP”として足りない可能性が高いところ（優先順）

1. **色（color theme）が「SSEに基づく」表示になっている保証がない**
2. 差分の “診断UI” が最小限（ログだけ）
3. WASM統合（本体）未接続（いまは PrototypeRuleEngine で代替）
4. Mol* 内部API差分への耐性（将来の壊れやすさ）

---

## 2. 「色が上書きされてない」理由（いまのコードから説明）

結論：**現状のコードは「色をSSE由来にする」と明示していません。**
なので “cartoon は変わったけど色は変わらない” は起きえます。

### 2-1. いまの流れ

* `applyOverrideSseToMolstarModel()` は SecondaryStructureProvider の `prop.value` を差し替える（SSEデータ自体は変える）
* `rebuildCartoonOnly()` は「既存reprを消して preset を再適用」するだけ

  * `polymer-cartoon` → だめなら `default` を試す
  * ただし **color theme を指定していない**

Mol* 側の preset が **「二次構造で色分け」** になっていなければ、SSEを差し替えても色は変わりません。
（逆に、preset が最初から SSE coloring なら色も変わります）

### 2-2. “色も変える” をMVPとして確実化するなら

次のどれかが必要です（ロードマップに入れるのが自然）：

* A) rebuild 後に representation の colorTheme を **secondary-structure** に切り替える
* B) そもそも preset 適用時に “secondary structure coloring” を指定できるルートを使う
* C) Mol* UI操作（右側パネル）で coloring を “Secondary Structure” に手動変更できる導線を作る（MVP最短）

---

## 3. 現在の実装の全体像（理解が追いつく用）

### 3-1. 実行導線（UI）

* `apps/sse-diag/src/components/MolstarSseDiagViewer.tsx`

  * 左：ファイルdrop + rangeLo/rangeHi + ログ
  * 右：Mol* plugin host

### 3-2. Pipeline（あなたのログに対応）

1. `createMolstarPlugin()`

   * `apps/sse-diag/src/molstar/plugin.ts`
   * **renderReact18 を渡す**（ここが過去に壊れやすかった点）
2. `loadMmcifText()`

   * `apps/sse-diag/src/molstar/load.ts`
3. `getMolstarStandardSse()`（baseline SSE取得）

   * `apps/sse-diag/src/molstar/standardSse.ts`
4. `extractResidueKeys()`（WASMへ渡す residue list を作る）

   * `apps/sse-diag/src/molstar/extract.ts`
   * chainId/seqId を頑丈に解決（segments 経由も実装済）
5. `engine.compute()`

   * 現状は `PrototypeRuleEngine`（範囲E、それ以外H）
   * `apps/sse-diag/src/domain/sse/engines/prototypeRuleEngine.ts`
6. `applyOverrideSseToMolstarModel()`

   * `apps/sse-diag/src/molstar/sseOverrideProvider.ts`
   * SecondaryStructureProvider の `prop.value` Map を差し替え、`prop.version++`
7. `rebuildCartoonOnly()`

   * `apps/sse-diag/src/molstar/state.ts`
8. diff

   * `apps/sse-diag/src/domain/sse/compare.ts`

---

## 4. 「なぜ MolstarSseDiagViewer.tsx を書き直す必要があったのか」要約（再整理）

これは **「SSE差し替えが効いているかを確実に観測できる最小導線」** を作るためです。

具体的には：

* **Mol* plugin の初期化が安定しない**と、以降全部が検証不能
  → `createPluginUI({ render: renderReact18 })` を明示して安定化
* Mol* が DOM 全体を覆う/レイアウトが崩れる問題があった
  → host の `position: relative` / `overflow: hidden`、`.msp-plugin` の inset 指定などで封じ込め
* “注入→再描画→差分確認” を 1クリックで再現する必要があった
  → `runPipeline()` を viewer 内に統合
* 「何が起きてるか」追えるログが必要
  → UIログ（console見なくても追える）を実装

つまり viewer の改修は **アルゴリズムの都合ではなく、Mol*統合の検証と再現性の都合**です。

---

## 5. いまの “既知の論点/リスク”（次に詰まりやすい所）

### 5-1. 色の反映（あなたが今感じてる課題）

* 現状：SSEデータは変えているが、**色テーマを変えていない**
* 対応：rebuild後に colorTheme を secondary-structure に寄せる（ロードマップ最優先）

### 5-2. Mol*内部API差分リスク

* `SecondaryStructureProvider.attach` の引数差（`(ctx, structure, void 0, true)` が通る/通らない等）
* prop の形が Map でないケースへの防御はあるが、将来壊れる可能性

### 5-3. マッピングの正しさ（mmCIFの落とし穴）

* chainId: label_asym_id / auth_asym_id のどちらを採用するか
  → 現状は “取れる方を取る” 方針（segments経由も含む）
* label_seq_id と auth_seq_id のズレ
  → ここが将来 “本当に診断する” フェーズで効いてくる

---

# 6. 今後の拡張計画（ロードマップ案）

## Phase 0（いま）: “SSE注入MVP” 完了ライン

**目標**：第三者に見せて「Mol*に外部SSEを注入できる」を確実に説明できる

やること（優先順）

1. **色の保証**（secondary structure coloring の固定化）
2. 差分サマリをUIに表示（H/E/Cのカウント、diff件数、上位差分一覧）
3. 「Mol*標準」「Override」のトグル（比較体験が一気に良くなる）
4. 最小の凡例（Helix/Sheet/None の色対応）

## Phase 1: WASM統合（本丸）

**目標**：PrototypeRuleEngine を WASM engine に置き換え

* `SseEngine` インターフェースは既にある（`apps/sse-diag/src/domain/sse/engine.ts`）
* `SseEngineOutput` は energy を持てる設計（将来スコア化できる）
* 実装タスク例：

  * wasm-pack/ビルド導線の整備
  * JS/TS境界で `ResidueKey[] -> wasm -> ResidueSseRecord[]` のI/O固定
  * 大きい構造での速度とメモリ計測

## Phase 2: “診断ツール” への進化

**目標**：差分を “原因別” に分類して見せる

例：

* 連続領域の差分をセグメント化（「ここが丸ごと食い違う」）
* ルール/閾値を変えて比較（複数アルゴリズム比較）
* 将来：DSSP/STRIDE系（ただし “サーバーに投げない” 条件は維持）

## Phase 3: 共通化（モノレポの勝ち筋）

**目標**：Mol*統合パターンを packages に切り出し、他ツールに波及

* `packages/molstar-adapter`（docs/architecture.md にある構想）
* sse-diag で固まったら抽出

---

# 7. 新しいチャットで再開するための “コピペ用 引継ぎプロンプト”

以下を次チャット冒頭に貼るとスムーズです。

---

**（コピペここから）**

私は Japan-Bio-Tools の `apps/sse-diag` を開発中。目的は「Mol* を SSOT とし、WASM 等の外部計算で得た SSE を Mol* の表示へ注入して比較できる診断ツール」を作ること。

現状（repomixの最新）：

* `MolstarSseDiagViewer.tsx` の `runPipeline()` が動作し、ログ上は以下が確認できる：

  * Mol*標準SSE取得 `getMolstarStandardSse()`：46 residues
  * residue key 抽出 `extractResidueKeys()`：46 keys
  * engine出力（PrototypeRuleEngine）：46 residues
  * `applyOverrideSseToMolstarModel()`：hit 46 / version更新OK
  * `rebuildCartoonOnly()` 実行済み
* ただし「cartoonは変わるが色は変わらない」ことがある。現状コードは色テーマを明示していないため、secondary-structure coloring を保証する改修が必要。

次にやりたいこと（優先順）：

1. rebuild後の representation の colorTheme を secondary-structure に固定し、色も確実に変わるようにする
2. UIに diff summary / diff table を出し、診断として見やすくする
3. Mol*標準 vs Override のトグルを入れる
4. その後、PrototypeRuleEngine を WASM エンジンに差し替える

参照すべき主要ファイル：

* `apps/sse-diag/src/components/MolstarSseDiagViewer.tsx`
* `apps/sse-diag/src/molstar/sseOverrideProvider.ts`
* `apps/sse-diag/src/molstar/standardSse.ts`
* `apps/sse-diag/src/molstar/extract.ts`
* `apps/sse-diag/src/molstar/state.ts`

**（コピペここまで）**

---

必要なら次のターンで、まず「色を確実にSSE由来にする」ために、**rebuildCartoonOnly() の直後に colorTheme を強制する実装方針を、Mol* 5.5.0 前提で“壊れにくい順”に3案**出します。
