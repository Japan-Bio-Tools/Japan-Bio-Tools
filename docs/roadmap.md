了解。いまの状況（POCとして **外部SSE注入→再描画** は通っている／ただし **色テーマ未固定**）を前提に、**Japan-Bio-Tools 憲法（Mol* SSOT・ブラウザ完結・段階実装・将来分離可能）**に沿ったロードマップを整理します。

※補足：一部の過去添付ファイルは期限切れになっていてこちらで再読込できません。ただロードマップ整理自体には支障ありません。もし特定mmCIFを前提に「検証セット」を決めたい場合だけ、そのmmCIFを再アップしてください。

---

## 全体ロードマップ（POC → “コア能力の確定” → 診断ツール化 → 共通化）

### Phase P（いま）：POC完了を“言い切れる”状態に固める（観測性・再現性）

**目的**：第三者に「外部データをMol*表示へ注入・上書きできる」を確実に説明できる

* P0-1 **色テーマを固定**（Secondary Structure coloring を強制）

  * *狙い*: 注入が効いたか目視でブレない（全部緑問題も解消）
* P0-2 **Override ON/OFF トグル**

  * *狙い*: 同一構造で標準⇄上書きを即比較できる（POC説得力が跳ねる）
* P0-3 **POC用ログ最小セット**

  * baseline件数 / engine件数 / hit件数 / diff件数 / H-E-Cカウント / 適用したcolorTheme名
* P0-4 **壊れた時のフォールバック**

  * attach引数差など、既にある try/catch を「ログで見える化」しておく

**Exit（完了条件）**

* どのmmCIFでも「標準⇄上書き」がUI操作1つで切替でき、色とログで差分が確認できる

---

### Phase 1：WASM統合（外部計算を本物に置換）

**目的**：PrototypeRuleEngine → Rust/WASM に差し替え（UIとMol*側を極力変えない）

* 1-1 **I/O固定（契約）**

  * `ResidueKey[] -> wasm -> ResidueSseRecord[]` を最小フィールドで固定
* 1-2 **WASMビルド導線**

  * wasm-pack or cargo + wasm-bindgen（ワークスペースに自然に載せる）
  * Web Worker / thread wasm は「必要になったら」導入（先行複雑化しない）
* 1-3 **性能・メモリの目安計測**

  * 大きめ構造でフリーズしない／失敗時に理由がログで追える

**Exit**

* Engine実装差し替えだけで、同じUI導線で注入・表示が成立

---

### Phase 2：診断ツールとして“最低限使える”形にする（ここからMVP寄り）

**目的**：POC能力を「診断体験」に変換（UIは最小でOK）

* 2-1 **差分一覧（最小UI）**

  * diff上位N件、連続領域のセグメント化（例：10–20がまとめて違う）
* 2-2 **クリック→ハイライト**

  * diff行クリックで該当残基を選択・強調（POCの“説明力”がさらに上がる）
* 2-3 **比較軸の拡張**

  * 複数エンジンを横並び比較（Engineプラガブル化の価値が出る）

**Exit**

* 「どこがどう違うか」をUIで最小限説明できる（ログではなくツールとして見せられる）

---

### Phase 3：アルゴリズム拡張と“注入対象の一般化”（Japan-Bio-Toolsのコアに寄せる）

**目的**：SSEだけでなく、任意スコア・領域アノテーションも“注入して上書き”できる基盤へ

* 3-1 **注入データモデルの拡張**

  * SSE以外（score, region label, confidence）を同じResidueKeyで運べる
* 3-2 **可視化表現のバリエーション**

  * 色だけでなく、表面・ラベル・グリフなど（ただし先行しすぎない）

**Exit**

* 「外部で計算・生成したカスタムデータを可視化へ注入・上書きできる」能力が一般化され、他ツールへ流用できる

---

### Phase 4：共通化（必要になった時点で切り出す）

**目的**：モノレポの勝ち筋。Mol*統合や注入パターンを packages に切り出し

* 4-1 `packages/molstar-adapter` 的な切り出し（※今は必須ではない）

  * 構造ロード、構造取得、残基キー抽出、注入・再描画、テーマ強制などをまとめる
* 4-2 回帰テストの共通化

  * “このMol*バージョンで注入が壊れてない”を自動で確認

**Exit**

* sse-diag 以外のアプリでも “同じ注入導線” を短距離で再利用できる

---

## 優先順位（いま一番コスパが高い順）

1. **色テーマ固定**（全部緑問題の根治＝POC観測が安定）
2. **Overrideトグル**（比較の説得力が最大）
3. **POCログ整備**（壊れても原因が追える）
4. **WASM I/O固定 → WASM差し替え**

---

## もし「次の1週間の作業単位」に落とすなら

* Day 1: 色テーマ固定（失敗時フォールバック込み）
* Day 2: Overrideトグル + ログ項目追加
* Day 3: “POC完了”の短いドキュメント化（再現手順・スクショ・想定FAQ）
* Day 4+: WASM I/O契約固定→最小wasmプロト

---

必要なら、次の返答で **Phase P（色固定＋トグル＋ログ）**を「ファイル別・差分パッチ単位」で具体化して出します（あなたの今の `state.ts` / `MolstarSseDiagViewer.tsx` の形に合わせて）。
